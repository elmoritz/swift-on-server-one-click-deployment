name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Type of version increment"
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
        default: "patch"
      release_notes:
        description: "Release notes (optional)"
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  create-release-version:
    name: Create Release Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/git-config

      - name: Calculate next version (3-part for production)
        id: bump
        uses: ./.github/actions/calculate-next-version
        with:
          version_type: ${{ inputs.version_type }}

      - name: Create and push production tag
        uses: ./.github/actions/git-tag-push
        with:
          version: ${{ steps.bump.outputs.version }}
          branch: "main"
          tag_prefix: "v"
          tag_message: "Production release version ${{ inputs.version_type }}"

  deploy-staging:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: create-release-version
    permissions:
      contents: read
      packages: write
    environment:
      name: staging
      url: ${{ vars.DEPLOYMENT_URL }}
    outputs:
      build-number: ${{ steps.build-number.outputs.build-number }}
      previous-version: ${{ steps.check-current.outputs.version }}
    env:
      STAGING_IMAGE_NAME: ${{ github.repository }}-staging # this is a workaround for githubs inability to use multiple Environments

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check current staging version
        id: check-current
        continue-on-error: true
        uses: ./.github/actions/health-check
        with:
          url: ${{ vars.DEPLOYMENT_URL }}
          max_retries: "3"
          retry_interval: "2"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}

      - name: Calculate build number
        id: build-number
        uses: ./.github/actions/calculate-build-number

      - name: Set version in app code
        uses: ./.github/actions/set-app-version
        with:
          version: ${{ needs.create-release-version.outputs.version }}
          build-number: ${{ steps.build-number.outputs.build-number }}
          environment: "staging"

      - name: Build Docker image
        id: docker-build
        uses: ./.github/actions/docker-build
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.STAGING_IMAGE_NAME }}
          version: ${{ needs.create-release-version.outputs.version }}-${{ steps.build-number.outputs.build-number }}
          tags: "latest"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        id: docker-push
        uses: ./.github/actions/docker-push
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.STAGING_IMAGE_NAME }}
          tags: ${{ steps.docker-build.outputs.tags }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to staging server
        uses: ./.github/actions/deploy-server
        with:
          ssh_host: ${{ secrets.SSH_HOST }}
          ssh_user: ${{ secrets.SSH_USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          # ssh_key_passphrase: ${{ secrets.KEY_PASSPHRASE || '' }}
          ssh_port: ${{ secrets.SSH_PORT || 22 }}
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.STAGING_IMAGE_NAME }}
          version: "latest"
          container_name: "container-todos-staging"
          port: "10000:8080"
          compose_folder: ${{ vars.COMPOSE_FOLDER }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Health check
        uses: ./.github/actions/health-check
        with:
          url: ${{ vars.DEPLOYMENT_URL }}
          max_retries: "30"
          retry_interval: "3"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}
          expected_version: ${{ needs.create-release-version.outputs.version }}
          expected_build_number: ${{ steps.build-number.outputs.build-number }}
          expected_environment: "staging"

      - name: Run API tests against staging
        uses: ./.github/actions/api-tests
        with:
          base_url: ${{ vars.DEPLOYMENT_URL }}

      - name: Staging deployment notification
        if: success()
        uses: ./.github/actions/deployment-notification
        with:
          status: "success"
          environment: "staging"
          version: ${{ needs.create-release-version.outputs.version }}
          version_type: ${{ inputs.version_type }}
          url: ${{ vars.DEPLOYMENT_URL }}

  pre-deployment-checks:
    name: Monitor Staging Deployment
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Monitor for 1 minutes
        uses: ./.github/actions/extended-monitoring
        with:
          url: ${{ vars.DEPLOYMENT_URL }}
          duration_minutes: "1"
          check_interval_seconds: "10"
          max_consecutive_failures: "3"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}

  deploy-production:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: [create-release-version, deploy-staging, pre-deployment-checks]
    permissions:
      contents: write
      packages: write
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Calculate build number
        id: build-number
        uses: ./.github/actions/calculate-build-number

      - name: Set version in app code
        uses: ./.github/actions/set-app-version
        with:
          version: ${{ needs.create-release-version.outputs.version }}
          build-number: ${{ steps.build-number.outputs.build-number }}
          environment: "production"

      - name: Build Docker image
        id: docker-build
        uses: ./.github/actions/docker-build
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          version: ${{ needs.create-release-version.outputs.version }}
          tags: "production,latest"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        uses: ./.github/actions/docker-push
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          tags: ${{ steps.docker-build.outputs.tags }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release-version.outputs.version }}
          name: Release v${{ needs.create-release-version.outputs.version }}
          body: |
            ## Release v${{ needs.create-release-version.outputs.version }}

            **Version Type:** ${{ inputs.version_type }}

            ${{ inputs.release_notes || 'No release notes provided.' }}

            ### Version Information
            - Version: ${{ needs.create-release-version.outputs.version }}
            - Type: ${{ inputs.version_type }}
            - Deployed: ${{ github.event.repository.updated_at }}

            ### Deployment
            This release has been automatically deployed to production.
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Deploy to production server
        id: deploy
        uses: ./.github/actions/deploy-server
        with:
          ssh_host: ${{ secrets.SSH_HOST }}
          ssh_user: ${{ secrets.SSH_USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          # ssh_key_passphrase: ${{ secrets.KEY_PASSPHRASE || '' }}
          ssh_port: ${{ secrets.SSH_PORT || 22 }}
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          version: ${{ needs.create-release-version.outputs.version }}
          container_name: "container-todos-production"
          port: "10001:8080"
          compose_folder: ${{ vars.COMPOSE_FOLDER }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Health check
        uses: ./.github/actions/health-check
        with:
          url: ${{ vars.DEPLOYMENT_URL }}
          max_retries: "30"
          retry_interval: "3"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}

      - name: Run smoke tests
        uses: ./.github/actions/api-tests
        with:
          base_url: ${{ vars.DEPLOYMENT_URL }}

      - name: Remove old production container
        if: success()
        uses: ./.github/actions/docker-cleanup
        with:
          ssh_host: ${{ secrets.SSH_HOST }}
          ssh_user: ${{ secrets.SSH_USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          # ssh_key_passphrase: ${{ secrets.KEY_PASSPHRASE || '' }}
          ssh_port: ${{ secrets.SSH_PORT || 22 }}
          container_name: "container-todos-production"
          deploy_path: ${{ vars.COMPOSE_FOLDER }}

      # - name: Rollback on failure
      #   if: failure()
      #   uses: ./.github/actions/rollback-deployment
      #   with:
      #     ssh_host: ${{ secrets.SSH_HOST }}
      #     ssh_user: ${{ secrets.SSH_USER }}
      #     ssh_key: ${{ secrets.SSH_KEY }}
      #     # ssh_key_passphrase: ${{ secrets.KEY_PASSPHRASE || '' }}
      #     ssh_port: ${{ secrets.SSH_PORT || 22 }}
      #     container_name: "container-todos-production"
      #     deploy_path: ${{ vars.COMPOSE_FOLDER }}

      # - name: Verify rollback
      #   if: failure()
      #   uses: ./.github/actions/health-check
      #   with:
      #     url: ${{ vars.DEPLOYMENT_URL }}
      #     max_retries: "20"
      #     retry_interval: "3"
      #     endpoint: ${{ vars.HEALTH_ENDPOINT }}

  post-deployment-monitoring:
    name: Monitor Production Deployment
    runs-on: ubuntu-latest
    needs: [create-release-version, deploy-production]
    if: success()
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extended monitoring (5 minutes)
        uses: ./.github/actions/extended-monitoring
        with:
          url: ${{ vars.DEPLOYMENT_URL }}
          duration_minutes: "5"
          check_interval_seconds: "10"
          max_consecutive_failures: "3"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}

      - name: Final validation
        uses: ./.github/actions/api-tests
        with:
          base_url: ${{ vars.DEPLOYMENT_URL }}

      - name: Deployment success notification
        if: success()
        uses: ./.github/actions/deployment-notification
        with:
          status: "success"
          environment: "production"
          version: ${{ needs.create-release-version.outputs.version }}
          version_type: ${{ inputs.version_type }}
          url: ${{ vars.DEPLOYMENT_URL }}

      - name: Alert on monitoring failure
        if: failure()
        uses: ./.github/actions/deployment-notification
        with:
          status: "failure"
          environment: "production"
          version: ${{ needs.create-release-version.outputs.version }}
          message: "CRITICAL: Production monitoring failed. Immediate attention required! Consider manual rollback if issues persist."

  create-release-branch:
    name: Create Release Branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: [create-release-version, post-deployment-monitoring]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/git-config

      - name: Create release branch
        run: |
          VERSION="${{ needs.create-release-version.outputs.version }}"
          BRANCH_NAME="release/v${VERSION}"

          # Fetch the tag
          git fetch origin tag "v${VERSION}"

          # Create the release branch from the tag
          git checkout -B "${BRANCH_NAME}" "v${VERSION}"
          git push origin "${BRANCH_NAME}"

          echo "✅ Created release branch: ${BRANCH_NAME}"
          echo "This branch represents the successfully deployed version v${VERSION}"

  cleanup-on-failure:
    name: Cleanup Failed Deployment
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      [
        create-release-version,
        deploy-staging,
        deploy-production,
        post-deployment-monitoring,
      ]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/git-config

      - name: Delete tag on failure
        run: |
          VERSION="${{ needs.create-release-version.outputs.version }}"
          TAG_NAME="v${VERSION}"

          # Check if tag exists
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
            echo "⚠️ Deployment failed - deleting tag ${TAG_NAME}"
            git push --delete origin "${TAG_NAME}" || echo "Tag already deleted or doesn't exist"
            echo "✅ Tag ${TAG_NAME} has been removed"
          else
            echo "ℹ️ Tag ${TAG_NAME} does not exist, nothing to clean up"
          fi
