name: Deploy to Staging

on:
  push:
    branches:
      - main
    paths:
      - 'todos-fluent/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'scripts/**'
      - '.swiftlint.yml'
      - '.github/workflows/deploy-staging.yml'
      - '.github/actions/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get current version
        id: version
        uses: ./.github/actions/read-version

      - name: Build and push Docker image
        id: docker
        uses: ./.github/actions/docker-build-push
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          version: ${{ steps.version.outputs.version }}
          tags: 'staging'
          push: 'true'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to staging server
        uses: ./.github/actions/deploy-server
        with:
          ssh_host: ${{ secrets.STAGING_HOST }}
          ssh_user: ${{ secrets.STAGING_USER }}
          ssh_key: ${{ secrets.STAGING_SSH_KEY }}
          ssh_port: ${{ secrets.STAGING_PORT || 22 }}
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          version: ${{ steps.version.outputs.version }}
          container_name: 'todos-staging'
          port: '8080:8080'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Health check
        uses: ./.github/actions/health-check
        with:
          url: ${{ vars.STAGING_URL }}
          max_retries: '30'
          retry_interval: '3'

      - name: Run API tests against staging
        uses: ./.github/actions/api-tests
        with:
          base_url: ${{ vars.STAGING_URL }}

      - name: Rollback on failure
        if: failure()
        uses: ./.github/actions/rollback-deployment
        with:
          ssh_host: ${{ secrets.STAGING_HOST }}
          ssh_user: ${{ secrets.STAGING_USER }}
          ssh_key: ${{ secrets.STAGING_SSH_KEY }}
          ssh_port: ${{ secrets.STAGING_PORT || 22 }}
          container_name: 'todos-staging'

  post-deployment-monitoring:
    name: Monitor Staging Deployment
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Monitor for 5 minutes
        uses: ./.github/actions/extended-monitoring
        with:
          url: ${{ vars.STAGING_URL }}
          duration_minutes: '5'
          check_interval_seconds: '30'
          max_consecutive_failures: '3'

      - name: Alert on monitoring failure
        if: failure()
        uses: ./.github/actions/deployment-notification
        with:
          status: 'failure'
          environment: 'staging'
          message: 'WARNING: Staging health checks failed during monitoring period. Manual intervention may be required.'
