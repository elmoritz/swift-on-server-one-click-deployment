name: Deploy to Staging

on:
  push:
    branches:
      - main
    paths:
      - "todos-fluent/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - "scripts/**"
      - ".swiftlint.yml"
      - ".github/workflows/deploy-staging.yml"
      - ".github/actions/**"
      - ".github/remote-scripts/**"
  workflow_dispatch:

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  DEPLOYMENT_URL: ${{ vars.DEPLOYMENT_URL }}
  COMPOSE_FOLDER: ${{ vars.COMPOSE_FOLDER }}

jobs:
  check-app-changes:
    name: Check for App Changes
    runs-on: ubuntu-latest
    outputs:
      app-changed: ${{ steps.filter.outputs.app }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for app changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'todos-fluent/**'
              - 'Dockerfile'

  deploy-staging:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: check-app-changes
    permissions:
      contents: read
      packages: write
    environment:
      name: staging
      url: ${{ env.DEPLOYMENT_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Get semantic version from git tags
        id: version
        uses: ./.github/actions/get-semantic-version

      - name: Calculate build number
        id: build-number
        uses: ./.github/actions/calculate-build-number

      - name: Set version in app code
        uses: ./.github/actions/set-app-version
        with:
          version: ${{ steps.version.outputs.version }}
          build-number: ${{ steps.build-number.outputs.build-number }}
          environment: "staging"

      - name: Build Docker image
        id: docker-build
        uses: ./.github/actions/docker-build
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          version: ${{ steps.version.outputs.version }}-${{ steps.build-number.outputs.build-number }}
          tags: "latest"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        id: docker-push
        uses: ./.github/actions/docker-push
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          tags: ${{ steps.docker-build.outputs.tags }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to staging server
        uses: ./.github/actions/deploy-server
        with:
          ssh_host: ${{ secrets.SSH_HOST }}
          ssh_user: ${{ secrets.SSH_USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          # ssh_key_passphrase: ${{ secrets.KEY_PASSPHRASE || '' }}
          ssh_port: ${{ secrets.SSH_PORT || 22 }}
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          version: "latest"
          container_name: "container-todos-staging"
          port: "10000:8080"
          compose_folder: ${{ env.COMPOSE_FOLDER }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Health check
        uses: ./.github/actions/health-check
        with:
          url: ${{ env.DEPLOYMENT_URL }}
          max_retries: "30"
          retry_interval: "3"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}
          expected_version: ${{ steps.version.outputs.version }}
          expected_build_number: ${{ steps.build-number.outputs.build-number }}
          expected_environment: "staging"

      - name: Run API tests against staging
        uses: ./.github/actions/api-tests
        with:
          base_url: ${{ env.DEPLOYMENT_URL }}

      # - name: Rollback on failure
      #   if: failure()
      #   uses: ./.github/actions/rollback-deployment
      #   with:
      #     ssh_host: ${{ secrets.SSH_HOST }}
      #     ssh_user: ${{ secrets.SSH_USER }}
      #     ssh_key: ${{ secrets.SSH_KEY }}
      #     # ssh_key_passphrase: ${{ secrets.KEY_PASSPHRASE || '' }}
      #     ssh_port: ${{ secrets.SSH_PORT || 22 }}
      #     container_name: "container-todos-staging"

  post-deployment-monitoring:
    name: Monitor Staging Deployment
    runs-on: ubuntu-latest
    needs: [check-app-changes, deploy-staging]
    if: success() && needs.check-app-changes.outputs.app-changed == 'true'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Monitor for 5 minutes
        uses: ./.github/actions/extended-monitoring
        with:
          url: ${{ vars.DEPLOYMENT_URL }}
          duration_minutes: "5"
          check_interval_seconds: "30"
          max_consecutive_failures: "3"
          endpoint: ${{ vars.HEALTH_ENDPOINT }}

      - name: Alert on monitoring failure
        if: failure()
        uses: ./.github/actions/deployment-notification
        with:
          status: "failure"
          environment: "staging"
          message: "WARNING: Staging health checks failed during monitoring period. Manual intervention may be required."
